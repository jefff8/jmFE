<!doctype html>
<html>

	<head>
		<meta charset="UTF-8">
		<title></title>
		<meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">
		<link href="../css/mui.min.css" rel="stylesheet" />
		<link rel="stylesheet" href="../css/my_css.css">	
		<style>
			#floorTab{
				text-align: center;
			}
			#floorTab button:hover{
				background-color: #efeff4;
			}
			.mui-preview-image.mui-fullscreen {
				position: fixed;
				z-index: 20;
				background-color: #000;
			}
			.mui-preview-header,
			.mui-preview-footer {
				position: absolute;
				width: 100%;
				left: 0;
				z-index: 10;
			}
			.mui-preview-header {
				height: 44px;
				top: 0;
			}
			.mui-preview-footer {
				height: 50px;
				bottom: 0px;
			}
			.mui-preview-header .mui-preview-indicator {
				display: block;
				line-height: 25px;
				color: #fff;
				text-align: center;
				margin: 15px auto 4;
				width: 70px;
				background-color: rgba(0, 0, 0, 0.4);
				border-radius: 12px;
				font-size: 16px;
			}
			.mui-preview-image {
				display: none;
				-webkit-animation-duration: 0.5s;
				animation-duration: 0.5s;
				-webkit-animation-fill-mode: both;
				animation-fill-mode: both;
			}
			.mui-preview-image.mui-preview-in {
				-webkit-animation-name: fadeIn;
				animation-name: fadeIn;
			}
			.mui-preview-image.mui-preview-out {
				background: none;
				-webkit-animation-name: fadeOut;
				animation-name: fadeOut;
			}
			.mui-preview-image.mui-preview-out .mui-preview-header,
			.mui-preview-image.mui-preview-out .mui-preview-footer {
				display: none;
			}
			.mui-zoom-scroller {
				position: absolute;
				display: -webkit-box;
				display: -webkit-flex;
				display: flex;
				-webkit-box-align: center;
				-webkit-align-items: center;
				align-items: center;
				-webkit-box-pack: center;
				-webkit-justify-content: center;
				justify-content: center;
				left: 0;
				right: 0;
				bottom: 0;
				top: 0;
				width: 100%;
				height: 100%;
				margin: 0;
				-webkit-backface-visibility: hidden;
			}
			.mui-zoom {
				-webkit-transform-style: preserve-3d;
				transform-style: preserve-3d;
			}
			.mui-slider .mui-slider-group .mui-slider-item img {
				width: auto;
				height: auto;
				max-width: 100%;
				max-height: 100%;
			}
			.mui-android-4-1 .mui-slider .mui-slider-group .mui-slider-item img {
				width: 100%;
			}
			.mui-android-4-1 .mui-slider.mui-preview-image .mui-slider-group .mui-slider-item {
				display: inline-table;
			}
			.mui-android-4-1 .mui-slider.mui-preview-image .mui-zoom-scroller img {
				display: table-cell;
				vertical-align: middle;
			}
			.mui-preview-loading {
				position: absolute;
				width: 100%;
				height: 100%;
				top: 0;
				left: 0;
				display: none;
			}
			.mui-preview-loading.mui-active {
				display: block;
			}
			.mui-preview-loading .mui-spinner-white {
				position: absolute;
				top: 50%;
				left: 50%;
				margin-left: -25px;
				margin-top: -25px;
				height: 50px;
				width: 50px;
			}
			.mui-preview-image img.mui-transitioning {
				-webkit-transition: -webkit-transform 0.5s ease, opacity 0.5s ease;
				transition: transform 0.5s ease, opacity 0.5s ease;
			}
			@-webkit-keyframes fadeIn {
				0% {
					opacity: 0;
				}
				100% {
					opacity: 1;
				}
			}
			@keyframes fadeIn {
				0% {
					opacity: 0;
				}
				100% {
					opacity: 1;
				}
			}
			@-webkit-keyframes fadeOut {
				0% {
					opacity: 1;
				}
				100% {
					opacity: 0;
				}
			}
			@keyframes fadeOut {
				0% {
					opacity: 1;
				}
				100% {
					opacity: 0;
				}
			}
			p img {
				max-width: 100px;
				height: 100px;
			}
			img{
				padding: 3px;
			}
			.myp{
				font-size: 1em;
				color: #000000;			
			}
			.myp2{				
				color:red;	
				text-indent:2em;	
			}
		</style>
	</head>

	<body>
		<header class="mui-bar mui-bar-nav">
		    <a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></a>
		    <a id="menu" class="mui-action-menu mui-icon mui-icon-bars mui-pull-right"></a>
		    <h1  class="mui-title">户号查看</h1>
		</header>
		<div class="mui-content">
			<form class="mui-input-group">
			    <form class="mui-input-group">
				    <div class="mui-input-row">
				        <label>栋号:</label>
				        <input type="text" id="buildingNum"  class="mui-input-clear" readonly="readonly"  >
				    </div>
				    <div class="mui-input-row">
				        <label>层数:</label>
				        <input type="number" id="floor" class="mui-input-clear" readonly="readonly"  >
				    </div>
				    <div class="mui-input-row">
				        <label>层户数:</label>
				        <input type="number" id="households" class="mui-input-clear" readonly="readonly"  >
				    </div>
				    <div class="mui-input-row">
				        <label>起始层:</label>
				        <input type="number" id="beginFloor" class="mui-input-clear" readonly="readonly" >
				    </div>
				    <div class="mui-input-row">
				        <label>起始时间:</label>
				        <input type="text" id="startTime" class="mui-input-clear"   readonly="readonly" >
				    </div>
				    <div class="mui-input-row">
				        <label>完成时间:</label>
				        <input type="text" id="acceptanceTime" class="mui-input-clear"   readonly="readonly" >
				    </div>
				</form> 
			</form>
			<br />
			<!--选项卡-->
			<div id="slider" class="mui-slider">
				<div id="sliderSegmentedControl" class="mui-slider-indicator mui-segmented-control mui-segmented-control-inverted">
					<a class="mui-control-item" href="#item1mobile">
						附件
					</a>
					<a class="mui-control-item" href="#item2mobile">
						所有分户
					</a>
				</div>
				<div id="sliderProgressBar" class="mui-slider-progress-bar mui-col-xs-6"></div>
				<div class="mui-slider-group">
					<div id="item1mobile" class="mui-slider-item mui-control-content ">
						<!--处理图片-->
					    <form id="img_content" class="" >
				        	<!--验收方案-->
				        	<p class="myp">验收方案: </p>
					        <p id="rwfj1"></p>
					        <p id="fj1Text"></p>
					        <!--整改通知单-->
					        <p class="myp" id="rectification_p">整改通知单: </p>
					        <p id="rwfj2"></p>
					        <p id="fj2Text"></p>
					    </form>
					</div>
					<div id="item2mobile" class="mui-slider-item mui-control-content mui-active">
						<!--楼盘div-->
						<div id="tabContent">
							<div id="floorTab">
								
							</div>
					    </div>	
					</div>
				</div>
			</div>
		</div>
		<script src="../js/mui.min.js"></script>
		<script src="../js/service.js"></script>
		<script type="text/javascript">
			mui.init({
				gestureConfig:{					
					longtap: true, //长按默认为false
					doubletap: true
				}
			}); 
			mui.plusReady(function(){
				//获取传值 
//				var self = plus.webview.currentWebview();
//				var itemId = self.ulId;
				//获取url参数值
				function geturl(name){
					var reg = new RegExp("(^|&)"+ name +"=([^&]*)(&|$)");
					var r = window.location.search.substr(1).match(reg);
					if(r!=null)return  unescape(r[2]);
					return null;
				}
				itemId = geturl("id");//项目id
				mobile = geturl("mobile");//手机号码
				var acceptanceForm = [];
				var acceptancePhoto = [];
				var acceptanceSummary = [];
				var rectification = [];
				var summary = [];
				var doc = document;
				var menu = doc.getElementById("menu");
				var fj2Text = doc.getElementById("fj2Text");
				var rectification_p = doc.getElementById("rectification_p");
				window.addEventListener('refresh', function(e){//执行刷新
				  	location.reload(); 
				});
				
				mui.ajax(url+'my_household/household_list.php',{
					data:{
						flag:'details',
						ulId:itemId
					},
					type:'post',
					dataType:'json',
					success:function(data){
						var length = data.length;
						buildingNum.value = data[0].栋号;
						floor.value = data[0].楼层;
						households.value = data[0].户数;
						beginFloor.value = data[0].起始层;
						startTime.value = data[0].起始日期;
						acceptanceTime.value = data[0].验收时间; 
						rectification = data[0].整改通知单.split("~*^*~");
						fj2Text.value = data[0].整改通知单说明; 
						summary = data[0].汇总表.split("~*^*~");
						fj1Text.value = data[0].汇总表说明;
						//汇总表
						if (summary.length>1) {
							for (var i=1;i<summary.length;i++){
								createimg('rwfj1',summary[i]);
							}
						}else{
							createtex('rwfj1');
						}	
						if(fj1Text.value){
							fj1Text.innerHTML="汇总表说明："+fj1Text.value;
						}
						//整改通知单
						if (rectification.length>1) {
							for (var i=1;i<rectification.length;i++){
								createimg('rwfj2',rectification[i]);
							}
						}else{
							rectification_p.classList.add("my_none");
						}	
						if(fj2Text.value){
							fj2Text.innerHTML="整改通知单说明："+fj2Text.value;
						}
					},
					error:function(type,xhr,errorThrown){
						alert('ajax错误'+type+'---'+errorThrown+"失败！");
					}
				});
				mui.ajax(url+'my_household/household_list.php',{
					data:{
						flag:"查看户号",
						itemId:itemId
					},
					type:'post',
					dataType:'json',
					timeout:10000,
					success:function(data){
						var length = data.length;
						for(var i=0;i<length;i++){
							var id = data[i].id ;
							var houseNum = data[i].户号 ;
							var status = data[i].状态;
							ShowTab(id,houseNum,status);
						}
					},
					error:function(xhr,type,errorThrown){
//						alert('ajax错误'+type+'---'+errorThrown+"失败！");
					}
				});
				//显示表格
				function ShowTab(id,houseNum,status){
					var floorTab = document.getElementById("floorTab");
					var newButton = document.createElement('button');
					var textNode = document.createTextNode(houseNum);
					newButton.id = id;
					if(status=='合格'){
						newButton.style.cssText = "margin:2px;width:80px;height:80px;background-color:limegreen;";
					}else if(status=='不合格'){
						newButton.style.cssText = "margin:2px;width:80px;height:80px;background-color:red;";
					}else if(status=='返工合格'){
						newButton.style.cssText = "margin:2px;width:80px;height:80px;background-color:orange;"; 
					}else{
						newButton.style.cssText = "margin:2px;width:80px;height:80px;";
					}
					newButton.appendChild(textNode);
					floorTab.appendChild(newButton);
				}
				//户号操作
				mui("#floorTab").on('tap','button',function(){
					var houseId = this.id;
					mui.ajax(url+'my_household/household_list.php',{
						data:{
							flag:"查看附件",
							houseId:houseId
						},
						type:'post',
						dataType:'json',
						timeout:10000,
						success:function(data){
							acceptanceForm = data[0].验收记录表.split("~*^*~");
							acceptancePhoto = data[0].验收照片.split("~*^*~");
							acceptanceSummary = data[0].验收汇总表.split("~*^*~");
							var recordText = data[0].验收记录表说明;
							var acceptText = data[0].验收照片说明;
							var summaryText = data[0].验收汇总表说明;
							mui.openWindow({
								url:'readimage.html',
								styles: {
									hardwareAccelerated:false
								},
								extras:{
									//传递参数
									acceptanceForm:acceptanceForm,
									acceptancePhoto:acceptancePhoto,
									acceptanceSummary:acceptanceSummary,
									recordText:recordText,
									acceptText:acceptText,
									summaryText:summaryText
								},
								show:{
									autoShow:true,//页面loaded事件发生后自动显示
									aniShow:'slide-in-right',//页面显示动画
									duration:'100'//页面动画持续时间
								},
								waiting:{
									autoShow:false,//自动显示等待框
								}
							});
						},
						error:function(xhr,type,errorThrown){
//							alert('ajax错误'+type+'---'+errorThrown+"失败！");
						}
					});
				});
				
				//动态创建图片
				var createimg=function(tplx,tpmc) {		
					var mysrc=url+"upload/"+tpmc;
					var fuys=document.getElementById(tplx);
					var img=document.createElement('img');
					img.src=mysrc;
					img.setAttribute( "data-preview-src", "" );
					img.setAttribute( "data-preview-group", "1" );
					fuys.appendChild(img);
				};		
				var createtex=function(tplx) {				
					var fuys=document.getElementById(tplx);
					fuys.innerHTML='<p class="myp2">该项未上传附件！</p>';			
				};
				//右上角按钮
				menu.addEventListener('tap',function(){
					mui.ajax(url+'check.php',{
						data:{
							ulId:"",
							mobile:mobile,
							flag:"division"
						},
						dataType:'json',
						type:'post',
						timeout:10000,
						success:function(data){
							if(data['单位']=='监督机构'||data['单位']=='管理员'){
								var btnArray = [
									{title:"通过"},
									{title:"不通过"}
								]; 
								plus.nativeUI.actionSheet({
									title:"操作", 
									cancel:"取消",
									buttons:btnArray
								},function(e){
									var index = e.index;	
									//var nextpage='';
									switch (index){
										case 1://审批通过
											mui.ajax(url+'my_household/household_list.php',{
												data:{
													flag:"审批通过",
													ulId:itemId
												},
												dataType:'json',
												type:'POST', 
												timeout:10000,
												success:function(data){
													mui.back();
													mui.toast('操作完成！',{ duration:'long', type:'div' })
												},
												error:function(xhr,type,errorThrown){
		//											alert('ajax错误'+type+'---'+errorThrown+"失败！");
												}
											});
											break;
										case 2:
											mui.openWindow({
												url:"fail.html",
												extras:{
													ulId:itemId
												},
												show: {
													aniShow:"pop-in"
												},
												waiting: {
													autoShow: false
												}
											});
											break;
									}	
								});
							}else{
								alert("抱歉，您没有操作权限或项目已审核过");
							}
						},
						error:function(xhr,type,errorThrown){
							alert('ajax错误'+type+'---'+errorThrown+"失败！");
						}
					});
				});
			});
		</script>
	</body>

</html>