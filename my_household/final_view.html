<!doctype html>
<html>

	<head>
		<meta charset="UTF-8">
		<title></title>
		<meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">
		<link href="../css/mui.min.css" rel="stylesheet" />
		<link rel="stylesheet" href="../css/my_css.css">	
		<style>
			#floorTab{
				text-align: center;
			}
			#floorTab button:hover{
				background-color: #efeff4;
			}
			#rwfj1_content{
				margin-top:30px;
			}
		</style>
	</head>

	<body>
		<header class="mui-bar mui-bar-nav">
		    <a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></a>
		    <h1  class="mui-title">户号查看</h1>
		</header>
		<div class="mui-content">
			<form class="mui-input-group">
			    <form class="mui-input-group">
				    <div class="mui-input-row">
				        <label>栋号:</label>
				        <input type="text" id="buildingNum"  class="mui-input-clear" readonly="readonly"  >
				    </div>
				    <div class="mui-input-row">
				        <label>楼层:</label>
				        <input type="number" id="floor" class="mui-input-clear" readonly="readonly"  >
				    </div>
				    <div class="mui-input-row">
				        <label>户数:</label>
				        <input type="number" id="households" class="mui-input-clear" readonly="readonly"  >
				    </div>
				    <div class="mui-input-row">
				        <label>起始层:</label>
				        <input type="number" id="beginFloor" class="mui-input-clear" readonly="readonly" >
				    </div>
				    <div class="mui-input-row">
				        <label>验收时间:</label>
				        <input type="text" id="acceptanceTime" class="mui-input-clear"   readonly="readonly" >
				    </div>
				</form> 
			</form>
			<p style="text-align: center;">以下为该项目的所有楼层,单击户号进行查看\操作</p>
			<p style="text-align: center;">注：绿色背景表示该楼层已上传附件</p>
			<!--楼盘div-->
		    <div id="tabContent">
				<div id="floorTab">
					
				</div>
		    </div>
		    <!--整改通知单-->
		    <div id="rwfj1_content" class="my_none">
		    	<p class="myp">整改通知单: </p>
				<p id="rwfj1">
				<p id="fj1Text">
					
				</p>
				</p>
		    </div>
		</div>
		<script src="../js/mui.min.js"></script>
		<script src="../js/service.js"></script>
		<script type="text/javascript">
			mui.init({
				gestureConfig:{					
					longtap: true, //长按默认为false
					doubletap: true
				}
			}); 
			mui.plusReady(function(){
				//获取传值 
//				var self = plus.webview.currentWebview();
//				var itemId = self.ulId;
				//获取url参数值
				function geturl(name){
					var reg = new RegExp("(^|&)"+ name +"=([^&]*)(&|$)");
					var r = window.location.search.substr(1).match(reg);
					if(r!=null)return  unescape(r[2]);
					return null;
				}
				var itemId = geturl("id");//项目id
				mobile = geturl("mobile");//手机号码
				var acceptanceForm = [];
				var acceptancePhoto = [];
				var acceptanceSummary = [];
				var rectification = [];
				var doc = document;
				var fj1Text = doc.getElementById("fj1Text");
				var rwfj1_content = doc.getElementById("rwfj1_content");
				window.addEventListener('refresh', function(e){//执行刷新
				  	location.reload(); 
				});
				
				mui.ajax(url+'my_household/household_list.php',{
					data:{
						flag:'details',
						ulId:itemId
					},
					type:'post',
					dataType:'json',
					success:function(data){
						var length = data.length;
						buildingNum.value = data[0].栋号;
						floor.value = data[0].楼层
						households.value = data[0].户数;
						beginFloor.value = data[0].起始层;
						acceptanceTime.value = data[0].验收时间; 
						rectification = data[0].整改通知单.split("~*^*~");
						fj1Text.value = data[0].整改通知单说明; 
						//整改通知单
						if (rectification.length>1) {
							rwfj1_content.classList.remove("my_none");
							for (var i=1;i<rectification.length;i++){
								createimg('rwfj1',rectification[i]);
							}
						}else{
							createtex('rwfj1');
						}	
						if(fj1Text.value){
							fj1Text.innerHTML="验收记录表说明："+fj1Text.value;
						}
					},
					error:function(type,xhr,errorThrown){
						alert('ajax错误'+type+'---'+errorThrown+"失败！");
					}
				});
				mui.ajax(url+'my_household/household_list.php',{
					data:{
						flag:"查看户号",
						itemId:itemId
					},
					type:'post',
					dataType:'json',
					timeout:10000,
					success:function(data){
						var length = data.length;
						for(var i=0;i<length;i++){
							var id = data[i].id ;
							var houseNum = data[i].户号 ;
							var status = data[i].上传状态;
							ShowTab(id,houseNum,status);
						}
					},
					error:function(xhr,type,errorThrown){
//						alert('ajax错误'+type+'---'+errorThrown+"失败！");
					}
				});
				//显示表格
				function ShowTab(id,houseNum,status){
					var floorTab = document.getElementById("floorTab");
					var newButton = document.createElement('button');
					var textNode = document.createTextNode(houseNum);
					newButton.id = id;
					if(status=='已上传'){
						newButton.style.cssText = "margin:2px;width:60px;height:60px;background-color:limegreen;";
					}else{
						newButton.style.cssText = "margin:2px;width:60px;height:60px;";
					}
					newButton.appendChild(textNode);
					floorTab.appendChild(newButton);
				}
				//户号操作
				mui("#floorTab").on('tap','button',function(){
					var houseId = this.id;
					mui.ajax(url+'my_household/household_list.php',{
						data:{
							flag:"查看附件",
							houseId:houseId
						},
						type:'post',
						dataType:'json',
						timeout:10000,
						success:function(data){
							acceptanceForm = data[0].验收记录表.split("~*^*~");
							acceptancePhoto = data[0].验收照片.split("~*^*~");
							acceptanceSummary = data[0].验收汇总表.split("~*^*~");
							var recordText = data[0].验收记录表说明;
							var acceptText = data[0].验收照片说明;
							var summaryText = data[0].验收汇总表说明;
							var btnArray = [
								{title:"查看附件"}
							];
							plus.nativeUI.actionSheet({
									title:"操作",
									cancel:"取消",
									buttons:btnArray
								},function(e){
									var index = e.index;	
									switch (index){
										case 1://查看附件
											mui.openWindow({
												url:'readimage.html',
												styles: {
													hardwareAccelerated:false
												},
												extras:{
													//传递参数
													acceptanceForm:acceptanceForm,
													acceptancePhoto:acceptancePhoto,
													acceptanceSummary:acceptanceSummary,
													recordText:recordText,
													acceptText:acceptText,
													summaryText:summaryText
												},
												show:{
													autoShow:true,//页面loaded事件发生后自动显示
													aniShow:'slide-in-right',//页面显示动画
													duration:'100'//页面动画持续时间
												},
												waiting:{
													autoShow:false,//自动显示等待框
												}
											});
											break;
									}
								}
							);
						},
						error:function(xhr,type,errorThrown){
//							alert('ajax错误'+type+'---'+errorThrown+"失败！");
						}
					});
				});
				
				//动态创建图片
				var createimg=function(tplx,tpmc) {		
					var mysrc=url+"upload/"+tpmc;
					var fuys=document.getElementById(tplx);
					var img=document.createElement('img');
					img.src=mysrc;
					img.setAttribute( "data-preview-src", "" );
					img.setAttribute( "data-preview-group", "1" );
					fuys.appendChild(img);
				};		
				var createtex=function(tplx) {				
					var fuys=document.getElementById(tplx);
					fuys.innerHTML='<p class="myp2">该项未上传附件！</p>';			
				};
				
				
			});
		</script>
	</body>

</html>