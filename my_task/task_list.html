<!doctype html>
<html>

	<head>
		<meta charset="UTF-8">
		<title></title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<link href="../css/mui.min.css" rel="stylesheet" />
		<link rel="stylesheet" href="../css/my_css.css">
		<link rel="stylesheet" href="../css/my_project_fhys_xz.css" />
		<link rel="stylesheet" href="../css/mui.picker.min.css"/>
		<link rel="stylesheet" href="../css/mui.poppicker.css"/>
	</head>

	<body>
		<div class="mui-content">
		    <header class="mui-bar mui-bar-nav">
		        <a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></a>
		        <h1 class="mui-title">任务列表</h1>
		    </header>
		   <div class="mui-content">
		   		<div style="padding: 10px 10px;">
					<div id="segmentedControl" class="mui-segmented-control">
						<div class="mui-slider">
			       			<div id="xuanxiangka" class="mui-slider-group mui-slider-loop ">
			        		   	<!--<div class="mui-slider-item">
			         		        <a id="a4" class="mui-control-item  "  href="#item4">
										实体检测
									</a>
									<a id="a5" class="mui-control-item"  href="#item5">
										材料抽检
									</a>
									<a id="a6" class="mui-control-item"  href="#item6">
										实体抽检
									</a>
									<a class=" mui-icon mui-icon-arrowleft mui-pull-left" style="bottom: 18px;"></a>
			         		    </div>-->
			         		    <div class="mui-slider-item">
									<a id="" class="mui-control-item  mui-active"  href="#item1">
										材料送检
									</a>
									<a id="" class="mui-control-item"  href="#item2">
										材料自检
									</a>
									<a id="" class="mui-control-item"  href="#item3">
										实体自检
									</a>
									<a id="" class="mui-control-item  "  href="#item4">
										实体检测
									</a>
									<!--<a class=" mui-icon mui-icon-arrowright mui-pull-right" style="bottom: 18px;"></a>-->
		         		   	    </div>
			      		  	</div>
			   			</div>
					</div> 
				</div>
				<!----------------------材料送检 ------------------------->
				<div id="item1" class="mui-control-content  mui-active">
				    <div id="scroll" class="mui-scroll-wrapper">
				    	<div id="send" class="mui-scroll rwdiv">
	
						</div>
				    </div>
				</div>
				<!----------------------材料送检 ------------------------->
				<!----------------------材料自检 ------------------------->
				<div id="item2" class="mui-control-content  mui-active">
				    <div id="scroll" class="mui-scroll-wrapper">
				    	<div id="self_inspection1" class="mui-scroll rwdiv">
	
						</div>
				    </div>
				</div>
				<!----------------------材料自检 ------------------------->
		   </div>
		</div>
		<script src="../js/mui.min.js"></script>
		<script src="../js/service.js"></script>
		<script type="text/javascript">
			mui.init({
				gestureConfig:{					
					longtap: true, //长按默认为false	
				}
			});
			mui.plusReady(function(){
				//获取url参数值
				function geturl(name){
					var reg = new RegExp("(^|&)"+ name +"=([^&]*)(&|$)");
					var r = window.location.search.substr(1).match(reg);
					if(r!=null)return  unescape(r[2]);
					return null;
				}
				uid = geturl("uid");
				unit = geturl("unit");
				unit = decodeURI(decodeURI(unit));
				count = "";
				mui.ajax(url+'my_task/task_list.php',{
					data:{
						flag:'获取工程时间戳',
						uid:uid
					},
					dataType:'json',
					type:'post',
					timeout:10000,
					success:function(data){
						var length = data.length;
						for(var i=0;i<length;i++){
							var pj_timestamp = data[i].时间戳;
							taskList(pj_timestamp);
						}
					},
					error:function(xhr,type,errorThrown){
//						alert('ajax错误'+type+'---'+errorThrown+"失败！");
					}
				});
				
				//根据对应工程查询任务
				function taskList(pj_timestamp){
//					alert(unit);
					mui.ajax(url+'my_task/task_list.php',{
						data:{
							flag:"材料送检",
							pj_timestamp:pj_timestamp,
							unit:unit
						},
						type:'post',
						dataType:'json',
						timeout:10000,
						success:function(data){
							var length = data.length;
							for(var i=0;i<length;i++){
								var id = data[i].id;
								var sjc = data[i].时间戳;
								var pj_name = data[i].工程名称;
								var type = data[i].取样类型;
								var scale = data[i].规格;
								var quantity = data[i].数量;
								var getGuy = data[i].取样人;
								var getDate = data[i].取样日期;
								var state = data[i].工程单状态;
								send(sjc,id,pj_name,type,scale,quantity,getGuy,getDate,state);
							}
						},
						error:function(xhr,type,errorThrown){
//							alert('ajax错误'+type+'---'+errorThrown+"失败！");
						}
					});
				}
				
				
				//动态创建项目
				function send(sjc,id,pj_name,type,scale,quantity,getGuy,getDate,state){
					if(state=='新增'||state=='新增复检'){
						color = 'blue2';
					}else{
						color = 'green2';
					}
					var ul = document.createElement("ul");
					ul.className = "mui-table-view mui-card my_list my_marginbottom10px";
					ul.id = id;
					if(state=='新增复检'||state=='取样复检'){
						ul.style.borderColor = "red";	
					}
					var send = document.getElementById("send");
					ul.innerHTML = '<li class="mui-table-view-cell my_backgroundcolor_'+color+'"><a class="a_color" href="../my_material/my_material_samDet.html?sjc='+sjc+'&gcid='+id+'&gcmc='+pj_name+'"><span class="mui-icon mui-icon-gear mui-pull-left my_fontweight my_color_white"></span><p class="mui-ellipsis my_style2">工程名称：'+ pj_name +'</p></a></li><li class="mui-table-view-cell"><p class="mui-ellipsis my_style1">取样类型：'+type+'</p></li><li class="mui-table-view-cell"><p class="mui-ellipsis my_style1">规格数量：'+scale+'/'+quantity+'</p></li><li class="mui-table-view-cell"><p class="mui-ellipsis my_style1">取样人：'+getGuy+'</p></li><li class="mui-table-view-cell"><p class="mui-ellipsis my_style1">取样日期：'+getDate+'</p></li>';
					send.appendChild(ul);
				}
				
				//材料送检操作
				mui("#send").on('longtap','ul',function(){
					var ulId = this.id;//获取当前的卡项的id
					mui.ajax(url+'my_task/my_send.php',{
						data:{
							flag:"获取状态",
							ulId:ulId
						},
						type:'post',
						dataType:'json',
						success:function(data){
//							alert(data);
							var status = data.工程单状态;
							if(status=='新增' || status=='新增复检'){
								var btnArray = [
								{title:"取样(施工单位)"},
								{title:"删除"}
								]; 
								plus.nativeUI.actionSheet({
									title:"操作", 
									cancel:"取消",
									buttons:btnArray
								},function(e){
									var index = e.index;	
									//var nextpage='';
									switch (index){
										case 1://取样
										if(status=='新增'){
											mui.ajax(url+'my_task/my_send.php',{
												data:{
													flag:"取样",
													ulId:ulId
												},
												dataType:'json',
												type:'POST', 
												timeout:10000,
												success:function(data){
//													alert(data.结果);
													mui.toast(data.结果,{ duration:'long', type:'div' });
													location.reload();//刷新本页面
												},
												error:function(xhr,type,errorThrown){
													alert('ajax错误'+type+'---'+errorThrown+"失败！");
												}
											});
										}else if(status=='新增复检'){
											mui.ajax(url+'my_task/my_send.php',{
												data:{
													flag:"取样复检",
													ulId:ulId
												},
												dataType:'json',
												type:'POST', 
												timeout:10000,
												success:function(data){
//													alert(data.结果);
													mui.toast(data.结果,{ duration:'long', type:'div' })
													location.reload();//刷新本页面
												},
												error:function(xhr,type,errorThrown){
//													alert('ajax错误'+type+'---'+errorThrown+"失败！");
												}
											});
										}
												
											break;
										case 2://删除
											mui.ajax(url+'my_task/my_send.php',{
												data:{
													flag:"删除",
													ulId:ulId
												},
												dataType:'json',
												type:'POST', 
												timeout:10000,
												success:function(data){
//													alert(data.结果);
													mui.toast(data.结果,{ duration:'long', type:'div' })
													location.reload();//刷新本页面
												},
												error:function(xhr,type,errorThrown){
		//											alert('ajax错误'+type+'---'+errorThrown+"失败！");
												}
											});
											break;
									}	
								 });
							}else if(status=='取样'||status=='取样复检'){
								var btnArray = [
								{title:"提交见证"},
								{title:"撤销取样"}
								];
								plus.nativeUI.actionSheet({
									title:"操作",
									cancel:"取消",
									buttons:btnArray
								},function(e){
									var index = e.index;	
									//var nextpage='';
									switch (index){
										case 1:
											//提交见证/*确定见证*/
											if(status=='取样'){
												mui.ajax(url+'my_task/my_send.php',{
													data:{
														flag:"提交见证",
														ulId:ulId
													},
													dataType:'json',
													type:'POST', 
													timeout:10000,
													success:function(data){
		//													alert(data.结果);
														mui.toast(data.结果,{ duration:'long', type:'div' })
														location.reload();//刷新本页面
													},
													error:function(xhr,type,errorThrown){
			//											alert('ajax错误'+type+'---'+errorThrown+"失败！");
													}
												});
											}else if(status=='取样复检'){
												mui.ajax(url+'my_task/my_send.php',{
													data:{
														flag:"提交复检见证",
														ulId:ulId
													},
													dataType:'json',
													type:'POST', 
													timeout:10000,
													success:function(data){
		//													alert(data.结果);
														mui.toast(data.结果,{ duration:'long', type:'div' })
														location.reload();//刷新本页面
													},
													error:function(xhr,type,errorThrown){
			//											alert('ajax错误'+type+'---'+errorThrown+"失败！");
													}
												});
											}
											
											break;
										case 2://撤销取样
										if(status=='取样'){
											mui.ajax(url+'my_task/my_send.php',{
												data:{
													flag:"撤销取样",
													ulId:ulId
												},
												dataType:'json',
												type:'POST', 
												timeout:10000,
												success:function(data){
//													alert(data.结果);
													mui.toast(data.结果,{ duration:'long', type:'div' })
													location.reload();//刷新本页面
												},
												error:function(xhr,type,errorThrown){
		//											alert('ajax错误'+type+'---'+errorThrown+"失败！");
												}
											});
										}else if(status=='取样复检'){
											mui.ajax(url+'my_task/my_send.php',{
												data:{
													flag:"撤销取样复检",
													ulId:ulId
												},
												dataType:'json',
												type:'POST', 
												timeout:10000,
												success:function(data){
//													alert(data.结果);
													mui.toast(data.结果,{ duration:'long', type:'div' })
													location.reload();//刷新本页面
												},
												error:function(xhr,type,errorThrown){
		//											alert('ajax错误'+type+'---'+errorThrown+"失败！");
												}
											});
										}
											
											break;
									}	
								  }
								);
							}
						},
						error:function(xhr,type,errorThrown){
							alert('ajax错误'+type+'---'+errorThrown+"失败！");
						}
					});
				});
				//材料送检操作
				
				
				//材料自检操作
				
				//材料自检操作
			});
		</script>
	</body>

</html>